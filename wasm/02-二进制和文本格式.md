### 二进制格式

模块是 Wasm 程序编译、传输和加载的单位，编译后的 Wasm 模块主要以二进制格式呈现。掌握 Wasm 模块的二进制格式是理解 解码、验证、实例化、执行等阶段的必要条件。

#### Wasm 二进制格式总体结构

和其他二进制格式（比如 Java 类文件、Lua 二进制快）一样，Wasm 二进制格式也是以 魔数(Magic Number) 和版本号开头。在魔数和版本号之后是模块的主体内容，这些内容被分门别类放在不同的段（Section，也叫 Segment）中。段可能会包含多个项目，Wasm 规范一共定义了 12 种段，并给每种段分配了 ID(从 0 到 11)。除了自定义段以外，其他所有的段都最多只能出现一次，且必须按照 ID 递增的顺序出现。

Wasm 二进制模块可能包含的 12 种 段。

1. 类型段 ID：1

   该段列出 Wasm 模块用到的所有函数类型（又叫函数签名，或者函数原型）。

2. 导入段和导出段 ID：2  ID：7

   这两个段分别列出模块所有的导入项和导出项，多个模块可以通过导入和导出项链接在一起。

3. 函数段和代码段 ID：3 ID：10

   内部函数信息被分开存储在两个段中，其中函数段实际上是一个索引表，列出内部函数所对应的签名索引；代码段存储内部函数的局部变量信息和字节码。函数段和代码段中的项目数量必须一致，且一一对应。

4. 表段和元素段 ID：4  ID：9

   表段列出模块内定义的所有表，元素段列出表初始化数据。Wasm 规范规定模块最多只能导入或定义一张表，所以即使模块有表段，里面也只能有一个项目。表主要和间接函数调用有关。

5. 内存段和数据段 ID：5  ID：11

   内存段列出模块内定义的所有内存，数据段列出内存初始化数据。Wasm 规范规定模块最多只能导入或定义一块内存，所以即使模块有内存段，里面也只能有一个项目。

6. 全局段 ID：6

   该段列出模块内定义的所有全局变量信息，包括值类型、可变性和初始值。

7. 起始段 ID：8

   该段给出模块的起始函数索引。和其他段有所不同，起始段只能有一个项目。起始段函数主要起到两个作用，一个是在模块加载后进行一些初始化工作；另一个是把模块变成可执行程序。如果模块有起始段，那么 Wasm 实现在加载模块后会自动执行起始函数。

8. 自定义段 ID：0

   该段是给编译器等工具使用的，里面可以存放函数名等调试信息，或者其他任何附加信息。自定义段不参与 Wasm 语义，所以即便是完全忽略自定义段也不影响模块的执行。

除了自定义段，其他段必须按照 ID 递增的顺序出现。之所以有这样的规定，是因为很多段之间存在信息的依赖关系。例如，由于导入段、函数段、代码段等都需要知道函数类型信息，所以类型段必须在这3个段之前出现；由于导入的函数、表、内存、全局变量在各自索引空间的最前面，所以导入段必须在这 4 个段之前出现；由于导出函数、表、内存、全局变量时需要知道其索引，所以导出段必须在这 4 个段之后出现。

Wasm 二进制格式的设计原则之一是可以一遍完成模块的解析、验证和编译（指 AOT 或 JIT 编译。换句话说，Wasm 实现可以在下载模块的同时进行解码、验证和编译。可流式处理是 Wasm 的特点之一，二进制模块中各个段的排列方式一定程度上是为了满足这一特点。另外，之所以要把函数的签名信息和其他信息分别存放在两个字段里，也是为了满足这一特点。

下面是模块的结构体定义

```wasm
type Module struct {
	Magic      uint32
	Version    unit32
	CustomSecs []CustomSec
	TypeSec    []FuncType
	ImportSec  []Import
	FuncSec    []TypeIdx
	TableSec   []TableType
	MemSec     []MemType
	GlobalSec  []Global
	ExportSec  []Export
	StartSec   *FuncIdx
	ElemSec    []Elem
	CodeSec    []Code
	DataSec    []Data
}
```

第一，Wasm 规范规定模块最多只能导入或定义一张表，内存也有同样限制。但这些限制只是暂时的，为了将来更容易扩展，也为了更准确地反映二进制格式，我们仍然把表和内存段定义成切片类型。第二，由于起始段只需要记录一个函数索引，所以我们把它定义成指针类型。如果该指针是 nil，则表示没有起始段。1

#### 索引空间

